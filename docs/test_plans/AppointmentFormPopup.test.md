# AppointmentFormPopup - Test Plan

1. Scope & Goals
- Verify that the popup for creating and editing appointments:
- Parses URL params and renders the correct mode.
- Loads existing data in edit mode.
- Performs patient search.
- Applies client-side conflict detection before saving.
- Saves via POST/PUT and deletes via DELETE.
- Sends postMessage to window.opener and closes the popup on success.
- Handles validation, error states, rounding, and input sanitization.

Out of scope: 
- styling, server correctness, full day view updates (covered in the parent window).


2. Test Environment

Libraries
- Jest (test runner)
- React Testing Library (@testing-library/react, @testing-library/user-event)
- React Router MemoryRouter with <Routes>/<Route>

--- 


# AppointmentFormPopup - Test Matrix

| Test # | Area                                         | Given URL / State                                                                                                                                               | User Action                                                                                                                                 | Mock API Response                                                                                                                                                                                                                                                                                | Expected Result                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|--------|----------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| T1     | Render                                       | ?mode=add&providerId=1&date=2025-08-04&time=10:00                                                                                                               | None                                                                                                                                        | n/a                                                                                                                                                                                                                                                                                              | Heading MAKE AN APPOINTMENT; Date input disabled and shows  2025-08-04;  Time shows 10:00;  Duration defaults 15;  Status select visible;  Buttons: Add Appointment, Cancel.                                                                                                                                                                                                                                                                                                                                                                          |
| T2     | Missing params                               | ?mode=add&providerId=1&date=2025-08-04                                                                                                                          | None                                                                                                                                        | n/a                                                                                                                                                                                                                                                                                              | Inline error text  Error: Missing time or provider ID. instead of form.                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| T3     | Render (edit preload)                        | ?mode=edit&providerId=1&apptId=42&date=2025-08-04&time=10:25                                                                                                    | None                                                                                                                                        | GET /appointments/42 → 200 { start_time:'10:25:00', duration_minutes:30, reason:'Follow-up', status:'being_seen', patient_id:7, firstname:'Jane', lastname:'Doe' }                                                                                                                               | Heading  EDIT AN APPOINTMENT ; Time  10:25 ; Duration  30 ; Reason  Follow-up ; Status select shows  In Room ; Name input displays  Doe, Jane.                                                                                                                                                                                                                                                                                                                                                                                                        |
| T4     | Conflict detection                           | /appointment-form-popup?mode=add&providerId=1&date=2025-08-04&time=10:00 (form loaded)                                                                          | In  Name  input type  Doe{enter}  → click row  “Doe, Jane”  → click  Add Appointment                                                        | 1)  GET /patients/search?keyword=Doe&mode=search_name  →  200   [ { id:7, firstname:'Jane', lastname:'Doe' } ]  2)  GET /appointments?date=2025-08-04&providerId=1  →  200   [ { id:99, start_time:'10:00:00', duration_minutes:30 } ]                                                           | Shows  alert("This time slot is already booked for the selected provider") . No   POST /appointments  or  PUT /appointments/:id  call is made (only the two GETs). Stays on the form (no close/postMessage side-effects).                                                                                                                                                                                                                                                                                                                             |
| T5     | Successful add                               | /appointment-form-popup?mode=add&providerId=1&date=2025-08-04&time=10:00  (form visible, default duration  15 , status  booked)                                 | 1) Type  Doe{enter}  in  Name  (triggers patient search). 2) Click row  “Doe, Jane”  to select patient (id  7 ). 3) Click  Add Appointment. | 1)  GET /patients/search?keyword=Doe&mode=search_name  →  [{ id:7, firstname:'Jane', lastname:'Doe' }] . 2)  GET /appointments?date=2025-08-04&providerId=1  →  []  (no conflicts). 3)  POST /appointments  →  { id:123 }.                                                                       | -  Network calls:  exactly 3 in order above; 3rd is  POST /appointments  with JSON body containing: { patientId:7, providerId:'1', date:'2025-08-04', time:'10:00', duration:15, status:'booked' } . -  UI side effects:   alert('Appointment booked')  shown;  window.opener.postMessage({ type:'appointment-added', date:'2025-08-04' }, '*')  sent;  window.close() called.                                                                                                                                                                        |
| T6     | Edit saves via PUT                           | /appointment-form-popup?mode=edit&providerId=1&apptId=42&date=2025-08-04&time=10:25                                                                             | 1) Wait for form to populate 2) Click  Save Changes                                                                                         | 1)  GET   /appointments/42  →  { id:42, start_time:'10:25:00', duration_minutes:30, reason:'Follow-up', status:'present', patient_id:7, firstname:'Jane', lastname:'Doe' }  2)  GET   /appointments?date=2025-08-04&providerId=1  →  []  (no conflicts) 3)  PUT   /appointments/42  →  { id:42 } | - Form pre-populates ( 'Doe, Jane' ,  '10:25' ,  '30' ,  'Follow-up' ) and title becomes  EDIT APPOINTMENT   -  PUT  called with URL ending  /appointments/42 , method  PUT , headers containing  Content-Type: application/json , and body containing:  { id:'42', patientId:7, providerId:'1', date:'2025-08-04', time:'10:25', duration:30, reason:'Follow-up', status:'present' }   -  alert('Appointment updated')  called  -  window.opener.postMessage({ type:'appointment-added', date:'2025-08-04' }, '*')  called  -  window.close() called |
| T7     | Successful delete                            | /appointment-form-popup?mode=edit&providerId=1&apptId=42&date=2025-08-04&time=10:25 . window.opener  is stubbed with  postMessage  spy;  window.close is spied. | Wait for form to populate → click  Delete Appointment                                                                                       | 1)  GET /appointments/42  →  { id: 42, start_time: "10:25:00", duration_minutes: 30, reason: "Follow-up", status: "present", patient_id: 7, firstname: "Jane", lastname: "Doe" }  (ok: true). 2)  DELETE /appointments/42  →  {} (ok: true).                                                     | fetch  called with  DELETE  to  /appointments/42 . window.opener.postMessage  called with  { type: "appointment-deleted", apptId: "42", date: "2025-08-04" } ,  '*' . window.close  called. No error alerts shown.                                                                                                                                                                                                                                                                                                                                    |
| T8     | Rounding to nearest 5 minutes (Add)          | /appointment-form-popup?mode=add&providerId=1&date=2025-08-04&time=10:28                                                                                        | Type Doe{enter} in Name, click patient row Doe, Jane, click Add Appointment                                                                 | 1) GET /patients/search?keyword=Doe&mode=search_name → [{ id:7, firstname:'Jane', lastname:'Doe' }] 2) GET /appointments?date=2025-08-04&providerId=1 → [] (no conflicts) 3) POST /appointments → { id:99 }                                                                                      | -  fetch  called 3 times in order: search, conflict check, then POST - Third call URL matches  /appointments  with  method: 'POST'  - POST body contains:  { date: '2025-08-04', time: '10:30', providerId: '1', patientId: 7 }  (10:28 rounded up to  10:30)                                                                                                                                                                                                                                                                                         |
| T9     | Duration input sanitization                  | /appointment-form-popup?mode=add&providerId=1&date=2025-08-04&time=10:00 rendered                                                                               | clear(dur)  then  type('025')                                                                                                               | None                                                                                                                                                                                                                                                                                             | Sanitizer removes leading zeros (e.g.,  025 → 25).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| T10    | Status mapping on save                       | /appointment-form-popup?mode=add&providerId=1&date=2025-08-04&time=10:00                                                                                        | Type  "Doe{enter}"  in  Name , click result  "Doe, Jane" . Change  Status  to  Here . Click  Add.                                           | 1)  GET /patients/search  →  [{ id:7, firstname:'Jane', lastname:'Doe' }]   2)  GET /appointments?...  →  []   3)  POST /appointments  →  { id:123 }                                                                                                                                             | POST  body uses backend value  status: 'present'  (UI “Here” → backend ‘present’), includes  patientId:7 ,  providerId:'1' ,  date:'2025-08-04' ,  time:'10:00'.                                                                                                                                                                                                                                                                                                                                                                                      |
| T11    | Search fails → alert & stay on form          | /appointment-form-popup?mode=add&providerId=1&date=2025-08-04&time=10:00                                                                                        | Type  "Doe{enter}"  in  Name                                                                                                                | GET /patients/search  →  500   { error:'Search failed' }                                                                                                                                                                                                                                         | alert('Search failed') shown. Do not switch to search view (no “Select Patient” heading). Add Appointment button still visible.                                                                                                                                                                                                                                                                                                                                                                                                                       |
| T12    | Skip self in conflict check, then save (PUT) | /appointment-form-popup?mode=edit&providerId=1&apptId=42&date=2025-08-04&time=10:25                                                                             | (After form populates) click  Save                                                                                                          | 1)  GET /appointments/42  → existing appt (id:42…)  2)  GET /appointments?date=…&providerId=…  →  [ {id:42,…}, {id:99,start_time:'12:00:00',duration_minutes:30} ]   3)  PUT /appointments/42  →  { id:42 }                                                                                      | PUT to  /appointments/42  occurs (no conflict alert). Then  postMessage({ type:'appointment-added', date:'2025-08-04' })  sent and  window.close() called.                                                                                                                                                                                                                                                                                                                                                                                            |
| T13    | Add fails → alert, no close                  | /appointment-form-popup?mode=add&providerId=1&date=2025-08-04&time=10:00                                                                                        | Pick patient via search; click  Add Appointment                                                                                             | 1)  GET /patients/search  →  [{ id:7,… }]   2)  GET /appointments?...  →  []   3)  POST /appointments  →  500   { error:'oops' }                                                                                                                                                                 | alert('Failed to book appointment') .  No   postMessage  and  no   window.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| T14    | Search view → pick row → back to form        | /appointment-form-popup?mode=add&providerId=1&date=2025-08-04&time=10:00                                                                                        | Type  "Doe{enter}"  in  Name  → click  "Doe, Jane" in results                                                                               | GET /patients/search  →  [{ id:7, firstname:'Jane', lastname:'Doe' }]                                                                                                                                                                                                                            | Shows  Select Patient  heading, then after row click returns to main form.  Name  input displays  "Doe, Jane".                                                                                                                                                                                                                                                                                                                                                                                                                                        |